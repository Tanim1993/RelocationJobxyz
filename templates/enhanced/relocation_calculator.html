{% extends "base.html" %}

{% block title %}Relocation Cost Calculator - Complete Moving Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>Relocation Cost Calculator
                    </h4>
                    <p class="text-muted mb-0">Calculate comprehensive costs for international relocation</p>
                </div>
                <div class="card-body">
                    <!-- Relocation Calculator Form -->
                    <form id="relocationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Current Location</h6>
                                
                                <div class="mb-3">
                                    <label for="fromLocation" class="form-label">From Location</label>
                                    <select class="form-select" id="fromLocation" required>
                                        <option value="">Select current location</option>
                                        <option value="New York, NY">New York, NY</option>
                                        <option value="San Francisco, CA">San Francisco, CA</option>
                                        <option value="London, UK">London, UK</option>
                                        <option value="Toronto, Canada">Toronto, Canada</option>
                                        <option value="Berlin, Germany">Berlin, Germany</option>
                                        <option value="Amsterdam, Netherlands">Amsterdam, Netherlands</option>
                                        <option value="Sydney, Australia">Sydney, Australia</option>
                                        <option value="Singapore">Singapore</option>
                                        <option value="Tokyo, Japan">Tokyo, Japan</option>
                                        <option value="Dubai, UAE">Dubai, UAE</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="toLocation" class="form-label">To Location</label>
                                    <select class="form-select" id="toLocation" required>
                                        <option value="">Select destination</option>
                                        <option value="New York, NY">New York, NY</option>
                                        <option value="San Francisco, CA">San Francisco, CA</option>
                                        <option value="London, UK">London, UK</option>
                                        <option value="Toronto, Canada">Toronto, Canada</option>
                                        <option value="Berlin, Germany">Berlin, Germany</option>
                                        <option value="Amsterdam, Netherlands">Amsterdam, Netherlands</option>
                                        <option value="Sydney, Australia">Sydney, Australia</option>
                                        <option value="Singapore">Singapore</option>
                                        <option value="Tokyo, Japan">Tokyo, Japan</option>
                                        <option value="Dubai, UAE">Dubai, UAE</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="familySize" class="form-label">Family Size</label>
                                    <select class="form-select" id="familySize" required>
                                        <option value="1">Just me</option>
                                        <option value="2">Me + Partner</option>
                                        <option value="3">Family of 3</option>
                                        <option value="4">Family of 4</option>
                                        <option value="5">Family of 5</option>
                                        <option value="6">Family of 6+</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="hasPets">
                                        <label class="form-check-label" for="hasPets">
                                            Moving with pets
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="hasVehicle">
                                        <label class="form-check-label" for="hasVehicle">
                                            Shipping vehicle
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Moving Details</h6>
                                
                                <div class="mb-3">
                                    <label for="householdSize" class="form-label">Household Items</label>
                                    <select class="form-select" id="householdSize">
                                        <option value="studio">Studio apartment</option>
                                        <option value="1bedroom">1 bedroom</option>
                                        <option value="2bedroom">2 bedroom</option>
                                        <option value="3bedroom">3 bedroom</option>
                                        <option value="4bedroom">4+ bedroom</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="urgency" class="form-label">Timeline</label>
                                    <select class="form-select" id="urgency">
                                        <option value="flexible">Flexible (6+ months)</option>
                                        <option value="normal">Normal (3-6 months)</option>
                                        <option value="urgent">Urgent (1-3 months)</option>
                                        <option value="immediate">Immediate (within 1 month)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="movingStyle" class="form-label">Moving Style</label>
                                    <select class="form-select" id="movingStyle">
                                        <option value="budget">Budget-friendly</option>
                                        <option value="standard">Standard service</option>
                                        <option value="premium">Premium/White-glove</option>
                                        <option value="corporate">Corporate relocation</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="currentSalary" class="form-label">Current Salary (Optional)</label>
                                    <input type="number" class="form-control" id="currentSalary" placeholder="e.g., 100000">
                                    <small class="text-muted">For salary comparison analysis</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="newSalary" class="form-label">New Job Offer (Optional)</label>
                                    <input type="number" class="form-control" id="newSalary" placeholder="e.g., 120000">
                                    <small class="text-muted">For cost-benefit analysis</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-calculator me-2"></i>Calculate Relocation Costs
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Section -->
    <div class="row mt-4" id="resultsSection" style="display: none;">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Relocation Cost Analysis</h5>
                </div>
                <div class="card-body">
                    <div id="relocationResults"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Relocation Calculator Form
document.getElementById('relocationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fromLocation = document.getElementById('fromLocation').value;
    const toLocation = document.getElementById('toLocation').value;
    const familySize = parseInt(document.getElementById('familySize').value);
    
    if (!fromLocation || !toLocation) {
        alert('Please select both current and destination locations');
        return;
    }
    
    if (fromLocation === toLocation) {
        alert('Please select different locations for comparison');
        return;
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating...';
    submitBtn.disabled = true;
    
    fetch('/api/relocation-analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            from_location: fromLocation,
            to_location: toLocation,
            family_size: familySize,
            household_size: document.getElementById('householdSize').value,
            urgency: document.getElementById('urgency').value,
            moving_style: document.getElementById('movingStyle').value,
            has_pets: document.getElementById('hasPets').checked,
            has_vehicle: document.getElementById('hasVehicle').checked,
            current_salary: parseFloat(document.getElementById('currentSalary').value) || 0,
            new_salary: parseFloat(document.getElementById('newSalary').value) || 0
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        displayRelocationResults(data);
        document.getElementById('resultsSection').style.display = 'block';
        
        // Scroll to results
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to calculate relocation costs');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function displayRelocationResults(data) {
    const container = document.getElementById('relocationResults');
    const fromLocation = document.getElementById('fromLocation').value;
    const toLocation = document.getElementById('toLocation').value;
    
    let html = '';
    
    // Summary Card
    html += '<div class="row mb-4">';
    html += '<div class="col-md-12">';
    html += '<div class="card bg-primary text-white">';
    html += '<div class="card-body text-center">';
    html += `<h5>Total Relocation Cost: $${data.total_relocation_cost.toLocaleString()}</h5>`;
    html += `<p class="mb-0">Moving from ${fromLocation} to ${toLocation}</p>`;
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // One-time Costs Breakdown
    html += '<div class="row mb-4">';
    html += '<div class="col-md-6">';
    html += '<div class="card">';
    html += '<div class="card-header">';
    html += '<h6 class="mb-0"><i class="fas fa-receipt me-2"></i>One-time Moving Costs</h6>';
    html += '</div>';
    html += '<div class="card-body">';
    
    for (const [category, cost] of Object.entries(data.one_time_costs)) {
        const categoryName = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `<div class="d-flex justify-content-between mb-2">`;
        html += `<span>${categoryName}:</span>`;
        html += `<strong>$${cost.toLocaleString()}</strong>`;
        html += `</div>`;
    }
    
    html += `<hr>`;
    html += `<div class="d-flex justify-content-between">`;
    html += `<strong>Total One-time:</strong>`;
    html += `<strong>$${data.total_relocation_cost.toLocaleString()}</strong>`;
    html += `</div>`;
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Monthly Cost Changes
    html += '<div class="col-md-6">';
    html += '<div class="card">';
    html += '<div class="card-header">';
    html += '<h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Monthly Cost Changes</h6>';
    html += '</div>';
    html += '<div class="card-body">';
    
    const monthlyDiff = data.monthly_cost_difference;
    const monthlyClass = monthlyDiff > 0 ? 'text-danger' : 'text-success';
    const monthlySymbol = monthlyDiff > 0 ? '+' : '';
    
    html += `<div class="d-flex justify-content-between mb-2">`;
    html += `<span>Monthly difference:</span>`;
    html += `<strong class="${monthlyClass}">${monthlySymbol}$${Math.abs(monthlyDiff).toLocaleString()}</strong>`;
    html += `</div>`;
    
    html += `<div class="d-flex justify-content-between mb-2">`;
    html += `<span>Annual difference:</span>`;
    html += `<strong class="${monthlyClass}">${monthlySymbol}$${Math.abs(monthlyDiff * 12).toLocaleString()}</strong>`;
    html += `</div>`;
    
    html += `<hr>`;
    html += `<div class="d-flex justify-content-between">`;
    html += `<strong>Break-even salary increase:</strong>`;
    html += `<strong>$${data.breakeven_salary_increase.toLocaleString()}</strong>`;
    html += `</div>`;
    
    if (monthlyDiff > 0) {
        html += `<small class="text-muted mt-2 d-block">You'll need at least $${data.breakeven_salary_increase.toLocaleString()} more annually to break even</small>`;
    } else {
        html += `<small class="text-success mt-2 d-block">Lower cost of living will save you money!</small>`;
    }
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Cost Breakdown by Category
    html += '<div class="row mb-4">';
    html += '<div class="col-md-12">';
    html += '<div class="card">';
    html += '<div class="card-header">';
    html += '<h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Cost of Living Comparison</h6>';
    html += '</div>';
    html += '<div class="card-body">';
    html += '<div class="row">';
    
    for (const [category, change] of Object.entries(data.cost_breakdown)) {
        const categoryName = category.replace(/_change/g, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const changeClass = change.startsWith('+') ? 'text-danger' : 'text-success';
        
        html += '<div class="col-md-4 mb-3">';
        html += '<div class="text-center">';
        html += `<h6>${categoryName}</h6>`;
        html += `<span class="badge ${change.startsWith('+') ? 'bg-danger' : 'bg-success'} fs-6">${change}</span>`;
        html += '</div>';
        html += '</div>';
    }
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Salary Analysis (if provided)
    const currentSalary = parseFloat(document.getElementById('currentSalary').value);
    const newSalary = parseFloat(document.getElementById('newSalary').value);
    
    if (currentSalary && newSalary) {
        const salaryIncrease = newSalary - currentSalary;
        const netBenefit = salaryIncrease - data.breakeven_salary_increase;
        
        html += '<div class="row">';
        html += '<div class="col-md-12">';
        html += '<div class="card border-info">';
        html += '<div class="card-header bg-info text-white">';
        html += '<h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Financial Impact Analysis</h6>';
        html += '</div>';
        html += '<div class="card-body">';
        
        html += '<div class="row">';
        html += '<div class="col-md-4 text-center">';
        html += '<h6>Salary Increase</h6>';
        html += `<h4 class="text-primary">$${salaryIncrease.toLocaleString()}</h4>`;
        html += '<small class="text-muted">Annual</small>';
        html += '</div>';
        
        html += '<div class="col-md-4 text-center">';
        html += '<h6>Break-even Required</h6>';
        html += `<h4 class="text-warning">$${data.breakeven_salary_increase.toLocaleString()}</h4>`;
        html += '<small class="text-muted">To cover increased costs</small>';
        html += '</div>';
        
        html += '<div class="col-md-4 text-center">';
        html += '<h6>Net Financial Benefit</h6>';
        const benefitClass = netBenefit > 0 ? 'text-success' : 'text-danger';
        const benefitSymbol = netBenefit > 0 ? '+' : '';
        html += `<h4 class="${benefitClass}">${benefitSymbol}$${netBenefit.toLocaleString()}</h4>`;
        html += '<small class="text-muted">Annual</small>';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="mt-3">';
        if (netBenefit > 0) {
            html += '<div class="alert alert-success">✅ This move makes financial sense! You\'ll be better off by $' + netBenefit.toLocaleString() + ' per year.</div>';
        } else {
            html += '<div class="alert alert-warning">⚠️ This move will cost you $' + Math.abs(netBenefit).toLocaleString() + ' per year after relocation costs.</div>';
        }
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
    }
    
    container.innerHTML = html;
}
</script>
{% endblock %}