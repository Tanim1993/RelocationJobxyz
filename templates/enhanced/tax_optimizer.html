{% extends "base.html" %}

{% block title %}International Tax Optimizer{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary">International Tax Optimizer</h1>
                <p class="lead text-muted">Minimize your global tax burden with AI-powered optimization strategies</p>
            </div>

            <div class="card shadow-lg border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Tax Optimization Analysis</h5>
                </div>
                <div class="card-body p-4">
                    <form id="taxOptimizationForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="annualIncome" class="form-label">Annual Income (USD)</label>
                                <input type="number" class="form-control" id="annualIncome" required placeholder="120000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="currentCountry" class="form-label">Current Country</label>
                                <select class="form-select" id="currentCountry" required>
                                    <option value="">Select current country</option>
                                    <option value="United States">United States</option>
                                    <option value="United Kingdom">United Kingdom</option>
                                    <option value="Canada">Canada</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Netherlands">Netherlands</option>
                                    <option value="Singapore">Singapore</option>
                                    <option value="Switzerland">Switzerland</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="targetCountries" class="form-label">Target Countries for Comparison</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="United States" id="us">
                                        <label class="form-check-label" for="us">United States</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="United Kingdom" id="uk">
                                        <label class="form-check-label" for="uk">United Kingdom</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Canada" id="ca">
                                        <label class="form-check-label" for="ca">Canada</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Germany" id="de">
                                        <label class="form-check-label" for="de">Germany</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Australia" id="au">
                                        <label class="form-check-label" for="au">Australia</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Netherlands" id="nl">
                                        <label class="form-check-label" for="nl">Netherlands</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Singapore" id="sg">
                                        <label class="form-check-label" for="sg">Singapore</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Switzerland" id="ch">
                                        <label class="form-check-label" for="ch">Switzerland</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Dubai" id="ae">
                                        <label class="form-check-label" for="ae">Dubai, UAE</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="employmentType" class="form-label">Employment Type</label>
                                <select class="form-select" id="employmentType">
                                    <option value="employee">Employee</option>
                                    <option value="contractor">Independent Contractor</option>
                                    <option value="freelancer">Freelancer</option>
                                    <option value="business_owner">Business Owner</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="maritalStatus" class="form-label">Marital Status</label>
                                <select class="form-select" id="maritalStatus">
                                    <option value="single">Single</option>
                                    <option value="married">Married</option>
                                    <option value="married_separate">Married Filing Separately</option>
                                </select>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="fas fa-chart-pie me-2"></i>Optimize Tax Strategy
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="mt-5" style="display: none;">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-globe me-2"></i>Tax Optimization Scenarios</h5>
                            </div>
                            <div class="card-body" id="scenariosResults">
                                <!-- Scenarios will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Recommendations</h5>
                            </div>
                            <div class="card-body" id="recommendationsResults">
                                <!-- Recommendations will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-piggy-bank me-2"></i>Potential Savings</h5>
                            </div>
                            <div class="card-body" id="savingsResults">
                                <!-- Savings will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('taxOptimizationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const selectedCountries = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value);
    
    if (selectedCountries.length === 0) {
        alert('Please select at least one target country for comparison.');
        return;
    }
    
    const formData = {
        income: parseInt(document.getElementById('annualIncome').value),
        current_country: document.getElementById('currentCountry').value,
        target_countries: selectedCountries,
        employment_type: document.getElementById('employmentType').value,
        marital_status: document.getElementById('maritalStatus').value
    };
    
    try {
        const response = await fetch('/api/tax-optimization', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            displayResults(data);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

function displayResults(data) {
    // Display scenarios
    const scenariosResults = document.getElementById('scenariosResults');
    scenariosResults.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Tax Rate</th>
                        <th>Net Income</th>
                        <th>Tax Savings</th>
                        <th>Strategies</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.scenarios.map(scenario => `
                        <tr>
                            <td><strong>${scenario.country}</strong></td>
                            <td><span class="badge bg-${scenario.total_tax_rate < 25 ? 'success' : scenario.total_tax_rate < 35 ? 'warning' : 'danger'}">${scenario.total_tax_rate}%</span></td>
                            <td><strong>$${scenario.net_income.toLocaleString()}</strong></td>
                            <td class="text-${scenario.tax_savings > 0 ? 'success' : 'danger'}">
                                ${scenario.tax_savings > 0 ? '+' : ''}$${scenario.tax_savings.toLocaleString()}
                            </td>
                            <td>
                                <button class="btn btn-outline-info btn-sm" onclick="showStrategies('${scenario.country}', ${JSON.stringify(scenario.strategies).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    // Display recommendations
    const recommendationsResults = document.getElementById('recommendationsResults');
    recommendationsResults.innerHTML = data.recommendations.map(rec => `
        <div class="alert alert-light border-start border-success border-4 mb-2">
            <i class="fas fa-check-circle text-success me-2"></i>${rec}
        </div>
    `).join('');
    
    // Display potential savings
    const savingsResults = document.getElementById('savingsResults');
    const bestScenario = data.scenarios.reduce((best, current) => 
        current.tax_savings > best.tax_savings ? current : best
    );
    
    savingsResults.innerHTML = `
        <div class="text-center">
            <h4 class="text-success">$${bestScenario.tax_savings.toLocaleString()}</h4>
            <p class="text-muted">Maximum annual tax savings by relocating to <strong>${bestScenario.country}</strong></p>
            <div class="progress mt-3">
                <div class="progress-bar bg-success" style="width: ${Math.min(100, (bestScenario.tax_savings / (data.scenarios[0].net_income * 0.1)) * 100)}%"></div>
            </div>
            <small class="text-muted">Potential savings as % of income</small>
        </div>
        <hr>
        <h6><i class="fas fa-info-circle text-info me-2"></i>Best Tax-Optimized Destination</h6>
        <p><strong>${bestScenario.country}</strong> offers the lowest effective tax rate at ${bestScenario.total_tax_rate}%</p>
    `;
    
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function showStrategies(country, strategies) {
    const strategiesText = strategies.map(strategy => `• ${strategy}`).join('\n');
    alert(`Tax Strategies for ${country}:\n\n${strategiesText}`);
}
</script>
{% endblock %}