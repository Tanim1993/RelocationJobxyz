{% extends "base.html" %}

{% block title %}Global Benefits Comparison Engine{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-12">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary">Global Benefits Comparison Engine</h1>
                <p class="lead text-muted">Compare international job offers with comprehensive compensation and benefits analysis</p>
            </div>

            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add Job Offers for Comparison</h5>
                </div>
                <div class="card-body p-4">
                    <div id="offersContainer">
                        <!-- Job offers will be added here dynamically -->
                    </div>
                    
                    <div class="text-center mb-4">
                        <button type="button" class="btn btn-outline-primary" onclick="addOffer()">
                            <i class="fas fa-plus me-2"></i>Add Job Offer
                        </button>
                    </div>

                    <div class="card border-0 bg-light">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Personal Priorities</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="salaryWeight" class="form-label">Salary Importance (0-10)</label>
                                    <input type="range" class="form-range" id="salaryWeight" min="0" max="10" value="8">
                                    <div class="d-flex justify-content-between">
                                        <small>Not Important</small>
                                        <span id="salaryValue" class="fw-bold">8</span>
                                        <small>Very Important</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="lifeBalanceWeight" class="form-label">Work-Life Balance (0-10)</label>
                                    <input type="range" class="form-range" id="lifeBalanceWeight" min="0" max="10" value="7">
                                    <div class="d-flex justify-content-between">
                                        <small>Not Important</small>
                                        <span id="lifeBalanceValue" class="fw-bold">7</span>
                                        <small>Very Important</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="growthWeight" class="form-label">Career Growth (0-10)</label>
                                    <input type="range" class="form-range" id="growthWeight" min="0" max="10" value="6">
                                    <div class="d-flex justify-content-between">
                                        <small>Not Important</small>
                                        <span id="growthValue" class="fw-bold">6</span>
                                        <small>Very Important</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="locationWeight" class="form-label">Location Quality (0-10)</label>
                                    <input type="range" class="form-range" id="locationWeight" min="0" max="10" value="5">
                                    <div class="d-flex justify-content-between">
                                        <small>Not Important</small>
                                        <span id="locationValue" class="fw-bold">5</span>
                                        <small>Very Important</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="benefitsWeight" class="form-label">Benefits Package (0-10)</label>
                                    <input type="range" class="form-range" id="benefitsWeight" min="0" max="10" value="7">
                                    <div class="d-flex justify-content-between">
                                        <small>Not Important</small>
                                        <span id="benefitsValue" class="fw-bold">7</span>
                                        <small>Very Important</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="relocationWeight" class="form-label">Relocation Support (0-10)</label>
                                    <input type="range" class="form-range" id="relocationWeight" min="0" max="10" value="9">
                                    <div class="d-flex justify-content-between">
                                        <small>Not Important</small>
                                        <span id="relocationValue" class="fw-bold">9</span>
                                        <small>Very Important</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-success btn-lg px-5" onclick="compareOffers()">
                            <i class="fas fa-balance-scale me-2"></i>Compare Offers
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="mt-5" style="display: none;">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Detailed Comparison</h5>
                            </div>
                            <div class="card-body" id="detailedComparison">
                                <!-- Detailed comparison will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Recommendation</h5>
                            </div>
                            <div class="card-body" id="recommendation">
                                <!-- Recommendation will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Sensitivity Analysis</h5>
                            </div>
                            <div class="card-body" id="sensitivityAnalysis">
                                <!-- Sensitivity analysis will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let offerCount = 0;

// Initialize sliders
document.getElementById('salaryWeight').addEventListener('input', function() {
    document.getElementById('salaryValue').textContent = this.value;
});
document.getElementById('lifeBalanceWeight').addEventListener('input', function() {
    document.getElementById('lifeBalanceValue').textContent = this.value;
});
document.getElementById('growthWeight').addEventListener('input', function() {
    document.getElementById('growthValue').textContent = this.value;
});
document.getElementById('locationWeight').addEventListener('input', function() {
    document.getElementById('locationValue').textContent = this.value;
});
document.getElementById('benefitsWeight').addEventListener('input', function() {
    document.getElementById('benefitsValue').textContent = this.value;
});
document.getElementById('relocationWeight').addEventListener('input', function() {
    document.getElementById('relocationValue').textContent = this.value;
});

function addOffer() {
    offerCount++;
    const offerHtml = `
        <div class="card mb-3 offer-card" data-offer-id="${offerCount}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Job Offer #${offerCount}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOffer(${offerCount})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="company_${offerCount}" placeholder="TechCorp Inc.">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Position</label>
                        <input type="text" class="form-control" id="position_${offerCount}" placeholder="Senior Software Engineer">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" id="location_${offerCount}" placeholder="New York, USA">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Base Salary (USD)</label>
                        <input type="number" class="form-control" id="salary_${offerCount}" placeholder="120000">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Annual Bonus (%)</label>
                        <input type="number" class="form-control" id="bonus_${offerCount}" placeholder="15">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Stock Options (USD)</label>
                        <input type="number" class="form-control" id="stock_${offerCount}" placeholder="25000">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Relocation Package (USD)</label>
                        <input type="number" class="form-control" id="relocation_package_${offerCount}" placeholder="10000">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Vacation Days</label>
                        <input type="number" class="form-control" id="vacation_${offerCount}" placeholder="25">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Health Insurance Quality</label>
                        <select class="form-select" id="health_${offerCount}">
                            <option value="excellent">Excellent</option>
                            <option value="good">Good</option>
                            <option value="average">Average</option>
                            <option value="basic">Basic</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Retirement Contribution (%)</label>
                        <input type="number" class="form-control" id="retirement_${offerCount}" placeholder="6">
                    </div>
                </div>
                
                <div class="mb-2">
                    <label class="form-label">Additional Benefits (comma-separated)</label>
                    <input type="text" class="form-control" id="benefits_${offerCount}" placeholder="Gym membership, Remote work, Professional development">
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="visa_${offerCount}">
                            <label class="form-check-label" for="visa_${offerCount}">Visa Sponsorship Provided</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remote_${offerCount}">
                            <label class="form-check-label" for="remote_${offerCount}">Remote Work Available</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('offersContainer').insertAdjacentHTML('beforeend', offerHtml);
}

function removeOffer(offerId) {
    const offerCard = document.querySelector(`[data-offer-id="${offerId}"]`);
    if (offerCard) {
        offerCard.remove();
    }
}

async function compareOffers() {
    const offers = [];
    const offerCards = document.querySelectorAll('.offer-card');
    
    if (offerCards.length < 2) {
        alert('Please add at least 2 job offers to compare.');
        return;
    }
    
    offerCards.forEach(card => {
        const offerId = card.dataset.offerId;
        offers.push({
            company: document.getElementById(`company_${offerId}`).value,
            position: document.getElementById(`position_${offerId}`).value,
            location: document.getElementById(`location_${offerId}`).value,
            base_salary: parseInt(document.getElementById(`salary_${offerId}`).value) || 0,
            annual_bonus_percent: parseInt(document.getElementById(`bonus_${offerId}`).value) || 0,
            stock_options: parseInt(document.getElementById(`stock_${offerId}`).value) || 0,
            relocation_package: parseInt(document.getElementById(`relocation_package_${offerId}`).value) || 0,
            vacation_days: parseInt(document.getElementById(`vacation_${offerId}`).value) || 0,
            health_insurance: document.getElementById(`health_${offerId}`).value,
            retirement_contribution: parseInt(document.getElementById(`retirement_${offerId}`).value) || 0,
            additional_benefits: document.getElementById(`benefits_${offerId}`).value.split(',').map(b => b.trim()),
            visa_sponsorship: document.getElementById(`visa_${offerId}`).checked,
            remote_work: document.getElementById(`remote_${offerId}`).checked
        });
    });
    
    const personalPriorities = {
        salary_weight: parseInt(document.getElementById('salaryWeight').value),
        work_life_balance_weight: parseInt(document.getElementById('lifeBalanceWeight').value),
        career_growth_weight: parseInt(document.getElementById('growthWeight').value),
        location_weight: parseInt(document.getElementById('locationWeight').value),
        benefits_weight: parseInt(document.getElementById('benefitsWeight').value),
        relocation_weight: parseInt(document.getElementById('relocationWeight').value)
    };
    
    const formData = {
        offers: offers,
        personal_priorities: personalPriorities
    };
    
    try {
        const response = await fetch('/api/benefits-comparison', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            displayResults(data);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function displayResults(data) {
    // Display detailed comparison
    const detailedComparison = document.getElementById('detailedComparison');
    detailedComparison.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Location</th>
                        <th>Total Compensation</th>
                        <th>Quality of Life</th>
                        <th>Growth Potential</th>
                        <th>Relocation Support</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.detailed_comparison.map(comp => `
                        <tr>
                            <td><strong>${comp.company}</strong><br><small>${comp.position || 'N/A'}</small></td>
                            <td>${comp.location}</td>
                            <td>
                                <span class="fw-bold text-success">$${comp.total_compensation.toLocaleString()}</span>
                                <br><small>Base: $${comp.benefit_breakdown.base_salary.toLocaleString()}</small>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${comp.quality_of_life_score >= 80 ? 'bg-success' : comp.quality_of_life_score >= 60 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${comp.quality_of_life_score}%">${comp.quality_of_life_score}%</div>
                                </div>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-info" style="width: ${comp.growth_potential}%">${comp.growth_potential}%</div>
                                </div>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-primary" style="width: ${comp.relocation_support}%">${comp.relocation_support}%</div>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    // Display recommendation
    const recommendation = document.getElementById('recommendation');
    const rec = data.recommendation;
    
    recommendation.innerHTML = `
        <div class="text-center mb-3">
            <h5 class="text-success"><i class="fas fa-trophy me-2"></i>Best Overall</h5>
            <p class="fw-bold">${rec.best_overall.company}</p>
        </div>
        
        <div class="mb-3">
            <h6><i class="fas fa-dollar-sign text-success me-2"></i>Best Financial</h6>
            <p class="small">${rec.best_financial.company}</p>
        </div>
        
        <div class="mb-3">
            <h6><i class="fas fa-heart text-danger me-2"></i>Best Lifestyle</h6>
            <p class="small">${rec.best_lifestyle.company}</p>
        </div>
        
        <div class="mt-3">
            <h6><i class="fas fa-lightbulb text-warning me-2"></i>Reasoning</h6>
            <p class="small">${rec.reasoning}</p>
        </div>
    `;
    
    // Display sensitivity analysis
    const sensitivityAnalysis = document.getElementById('sensitivityAnalysis');
    sensitivityAnalysis.innerHTML = `
        <div class="alert alert-info">
            <h6><i class="fas fa-chart-line me-2"></i>What-If Scenarios</h6>
            <p class="mb-0">${data.sensitivity_analysis}</p>
        </div>
    `;
    
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

// Add initial offer
addOffer();
addOffer();
</script>
{% endblock %}