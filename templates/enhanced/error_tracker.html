{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6 fw-bold text-primary">
                    <i class="fas fa-bug me-3"></i>Error Tracker
                </h1>
                <button class="btn btn-outline-danger" onclick="clearErrorLog()">
                    <i class="fas fa-trash me-2"></i>Clear Logs
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Button Error Log
                    </h5>
                </div>
                <div class="card-body">
                    <div id="errorLogContent">
                        <p class="text-muted">Loading error logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools me-2"></i>Debug Tools
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="testAllButtons()">
                                <i class="fas fa-play me-2"></i>Test All Buttons
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-secondary w-100" onclick="exportErrorLog()">
                                <i class="fas fa-download me-2"></i>Export Log
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="refreshErrors()">
                                <i class="fas fa-sync me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadErrorLog() {
    try {
        const errorLog = JSON.parse(localStorage.getItem('buttonErrorLog') || '[]');
        const content = document.getElementById('errorLogContent');
        
        if (errorLog.length === 0) {
            content.innerHTML = '<p class="text-success"><i class="fas fa-check me-2"></i>No errors logged yet!</p>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-striped">';
        html += '<thead class="table-dark"><tr>';
        html += '<th>Time</th><th>Tool</th><th>Action</th><th>Error</th><th>URL</th>';
        html += '</tr></thead><tbody>';
        
        errorLog.reverse().forEach(error => {
            const time = new Date(error.timestamp).toLocaleString();
            html += `<tr>
                <td><small>${time}</small></td>
                <td><span class="badge bg-primary">${error.tool}</span></td>
                <td><span class="badge bg-secondary">${error.action}</span></td>
                <td><small class="text-danger">${error.error}</small></td>
                <td><small>${error.url.split('/').pop()}</small></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        content.innerHTML = html;
        
    } catch (error) {
        console.error('Failed to load error log:', error);
        document.getElementById('errorLogContent').innerHTML = 
            '<p class="text-danger">Failed to load error log</p>';
    }
}

function clearErrorLog() {
    localStorage.removeItem('buttonErrorLog');
    loadErrorLog();
    showSuccess('Error log cleared successfully');
}

function exportErrorLog() {
    try {
        const errorLog = JSON.parse(localStorage.getItem('buttonErrorLog') || '[]');
        const dataStr = JSON.stringify(errorLog, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `error-log-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showSuccess('Error log exported successfully');
        
    } catch (error) {
        console.error('Export failed:', error);
        showError('Failed to export error log');
    }
}

function testAllButtons() {
    const buttons = document.querySelectorAll('button');
    let buttonCount = 0;
    
    buttons.forEach(button => {
        if (button.type !== 'submit' && !button.onclick && !button.hasAttribute('data-bs-dismiss')) {
            buttonCount++;
        }
    });
    
    showSuccess(`Found ${buttonCount} buttons to test`);
}

function refreshErrors() {
    loadErrorLog();
    showSuccess('Error log refreshed');
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
    
    setTimeout(() => alert.remove(), 3000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
    
    setTimeout(() => alert.remove(), 3000);
}

// Load error log on page load
document.addEventListener('DOMContentLoaded', loadErrorLog);

// Auto-refresh every 30 seconds
setInterval(loadErrorLog, 30000);
</script>
{% endblock %}